<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Right Peg Match - Advanced API Connection Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      line-height: 1.5;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      color: #374151;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    h1, h2 {
      color: #2563eb;
      margin-top: 0;
    }
    .log {
      font-family: monospace;
      font-size: 13px;
      background-color: #f1f5f9;
      padding: 15px;
      border-radius: 6px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    .success {
      color: #16a34a;
      font-weight: bold;
    }
    .error {
      color: #dc2626;
      font-weight: bold;
    }
    .warning {
      color: #ea580c;
      font-weight: bold;
    }
    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      margin-right: 8px;
    }
    button:hover {
      background-color: #1d4ed8;
    }
    button:disabled {
      background-color: #93c5fd;
      cursor: not-allowed;
    }
    .code {
      font-family: monospace;
      background-color: #f1f5f9;
      padding: 4px 6px;
      border-radius: 4px;
      word-break: break-all;
    }
    .flex {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-online {
      background-color: #16a34a;
    }
    .status-offline {
      background-color: #dc2626;
    }
    .status-unknown {
      background-color: #f59e0b;
    }
    #connectivity-status {
      font-weight: bold;
      margin-left: 8px;
    }
    .loading::after {
      content: "...";
      display: inline-block;
      animation: ellipsis 1.2s infinite;
      width: 20px;
      text-align: left;
    }
    @keyframes ellipsis {
      0% { content: "."; }
      33% { content: ".."; }
      66% { content: "..."; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Right Peg Match Connection Test</h1>
    <p>This tool tests various methods of connecting to the backend API:</p>
    
    <div class="flex">
      <div>
        <span class="status-indicator" id="status-indicator"></span>
        <span id="connectivity-status">Checking connection...</span>
      </div>
    </div>
    
    <div>
      <h2>Backend API Endpoint</h2>
      <p class="code" id="api-url">https://7a407b74-b1a3-43f7-bf8a-d00fad3554e3-00-15b02g7uh8r3y.riker.replit.dev/api</p>
      
      <div class="flex" style="margin-bottom: 16px;">
        <button id="test-all-button">Run All Tests</button>
        <button id="test-jsonp-button">Test JSONP Connection</button>
        <button id="test-image-button">Test Image Connection</button>
        <button id="test-proxy-button">Test Proxy Connection</button>
      </div>
      
      <div id="log" class="log">Ready to run connection tests...</div>
    </div>
  </div>

  <div class="card">
    <h2>Connection Troubleshooting</h2>
    <p>If you're experiencing connection issues:</p>
    <ol>
      <li>Make sure the Replit server is running</li>
      <li>Check if you can access <a href="https://7a407b74-b1a3-43f7-bf8a-d00fad3554e3-00-15b02g7uh8r3y.riker.replit.dev/api/ping-test" target="_blank">the API directly</a></li>
      <li>Verify your browser is not blocking cross-origin requests</li>
      <li>Try using one of the alternative connection methods above</li>
    </ol>
  </div>

  <script>
    // Configuration
    const API_URL = 'https://7a407b74-b1a3-43f7-bf8a-d00fad3554e3-00-15b02g7uh8r3y.riker.replit.dev/api';
    const CORS_PROXY = 'https://api.allorigins.win/get?url=';
    
    // UI Elements
    const statusIndicator = document.getElementById('status-indicator');
    const connectivityStatus = document.getElementById('connectivity-status');
    const logElement = document.getElementById('log');
    const apiUrlElement = document.getElementById('api-url');
    const testAllButton = document.getElementById('test-all-button');
    const testJsonpButton = document.getElementById('test-jsonp-button');
    const testImageButton = document.getElementById('test-image-button');
    const testProxyButton = document.getElementById('test-proxy-button');
    
    // Display the API URL
    apiUrlElement.textContent = API_URL;
    
    // Set initial UI state
    statusIndicator.className = 'status-indicator status-unknown';
    
    // Logging function
    function log(message, type = 'info') {
      const timestamp = new Date().toISOString().split('T')[1].slice(0, 8);
      const className = type === 'error' ? 'error' : 
                        type === 'success' ? 'success' : 
                        type === 'warning' ? 'warning' : '';
      
      const formattedMessage = `[${timestamp}] ${message}`;
      console.log(formattedMessage);
      
      logElement.innerHTML += `<div class="${className}">${formattedMessage}</div>`;
      logElement.scrollTop = logElement.scrollHeight;
    }
    
    // Update connection status UI
    function updateConnectionStatus(isConnected, message = '') {
      statusIndicator.className = `status-indicator ${isConnected ? 'status-online' : 'status-offline'}`;
      connectivityStatus.textContent = message || (isConnected ? 'Connected' : 'Disconnected');
      connectivityStatus.className = isConnected ? 'success' : 'error';
    }
    
    // Set buttons to loading state
    function setButtonsLoading(loading) {
      [testAllButton, testJsonpButton, testImageButton, testProxyButton].forEach(button => {
        button.disabled = loading;
      });
    }
    
    // Test JSONP connection using a script tag
    async function testJSONPConnection() {
      return new Promise((resolve) => {
        log('Starting JSONP connection test...');
        
        // Create a unique callback name 
        const callbackName = 'jsonpCallback_' + Math.floor(Math.random() * 10000000);
        
        // Add the callback to window
        window[callbackName] = function(data) {
          // Clean up
          document.body.removeChild(script);
          delete window[callbackName];
          
          log(`JSONP response received: ${JSON.stringify(data)}`, 'success');
          resolve({ success: true, data });
        };
        
        // Create script element
        const script = document.createElement('script');
        script.src = `${API_URL}/ping-jsonp?callback=${callbackName}&t=${Date.now()}`;
        
        // Set timeout
        const timeoutId = setTimeout(() => {
          if (document.body.contains(script)) {
            document.body.removeChild(script);
            delete window[callbackName];
            log('JSONP request timed out after 5 seconds', 'error');
            resolve({ success: false, error: 'Timeout' });
          }
        }, 5000);
        
        // Handle load error
        script.onerror = () => {
          clearTimeout(timeoutId);
          document.body.removeChild(script);
          delete window[callbackName];
          log('JSONP request failed to load', 'error');
          resolve({ success: false, error: 'Failed to load' });
        };
        
        // Add to document
        document.body.appendChild(script);
      });
    }
    
    // Test connection using image loading
    async function testImageConnection() {
      return new Promise((resolve) => {
        log('Starting image connection test...');
        
        const startTime = Date.now();
        const img = new Image();
        
        img.onload = function() {
          const elapsed = Date.now() - startTime;
          log(`Image loaded successfully in ${elapsed}ms`, 'success');
          resolve({ success: true, timing: elapsed });
        };
        
        img.onerror = function() {
          const elapsed = Date.now() - startTime;
          log(`Image failed to load after ${elapsed}ms`, 'error');
          resolve({ success: false, error: 'Failed to load', timing: elapsed });
        };
        
        // Set source with cache-busting query param
        img.src = `${API_URL}/ping-image?t=${Date.now()}`;
        log(`Requesting image from: ${img.src}`);
        
        // Set timeout
        setTimeout(() => {
          if (!img.complete) {
            img.src = ''; // Cancel the request
            log('Image request timed out after 5 seconds', 'error');
            resolve({ success: false, error: 'Timeout' });
          }
        }, 5000);
      });
    }
    
    // Test connection through a CORS proxy
    async function testProxyConnection() {
      log('Starting proxy connection test...');
      
      try {
        const proxyUrl = `${CORS_PROXY}${encodeURIComponent(API_URL + '/ping-test?t=' + Date.now())}`;
        log(`Using proxy: ${proxyUrl}`);
        
        const startTime = Date.now();
        const response = await fetch(proxyUrl);
        const elapsed = Date.now() - startTime;
        
        if (response.ok) {
          const data = await response.json();
          log(`Proxy request succeeded in ${elapsed}ms`, 'success');
          
          if (data.contents && data.contents.includes('online')) {
            log(`API is reachable via proxy: ${data.contents}`, 'success');
            return { success: true, data: data.contents, timing: elapsed };
          } else {
            log(`API returned unexpected response via proxy: ${data.contents}`, 'warning');
            return { success: false, error: 'Unexpected response', data: data.contents, timing: elapsed };
          }
        } else {
          log(`Proxy request failed with status ${response.status}`, 'error');
          return { success: false, error: `HTTP ${response.status}`, timing: elapsed };
        }
      } catch (error) {
        log(`Proxy request error: ${error.message}`, 'error');
        return { success: false, error: error.message };
      }
    }
    
    // Run all tests
    async function runAllTests() {
      // Clear log and set loading state
      logElement.innerHTML = '';
      setButtonsLoading(true);
      statusIndicator.className = 'status-indicator status-unknown';
      connectivityStatus.textContent = 'Testing connection...';
      connectivityStatus.className = '';
      
      log('Starting comprehensive connection tests...');
      
      // Run tests sequentially
      const jsonpResult = await testJSONPConnection();
      const imageResult = await testImageConnection();
      const proxyResult = await testProxyConnection();
      
      // Check if any test was successful
      const anySuccess = jsonpResult.success || imageResult.success || proxyResult.success;
      
      // Update overall status
      if (anySuccess) {
        updateConnectionStatus(true, 'Connected! At least one method works.');
        log('Connection established successfully via at least one method.', 'success');
      } else {
        updateConnectionStatus(false, 'All connection methods failed');
        log('All connection methods failed. The API may be unavailable.', 'error');
      }
      
      // Enable buttons
      setButtonsLoading(false);
      
      return {
        jsonp: jsonpResult,
        image: imageResult,
        proxy: proxyResult,
        anySuccess
      };
    }
    
    // Event Listeners
    testAllButton.addEventListener('click', runAllTests);
    testJsonpButton.addEventListener('click', async () => {
      logElement.innerHTML = '';
      setButtonsLoading(true);
      const result = await testJSONPConnection();
      updateConnectionStatus(result.success, result.success ? 'JSONP connected!' : 'JSONP failed');
      setButtonsLoading(false);
    });
    
    testImageButton.addEventListener('click', async () => {
      logElement.innerHTML = '';
      setButtonsLoading(true);
      const result = await testImageConnection();
      updateConnectionStatus(result.success, result.success ? 'Image connected!' : 'Image failed');
      setButtonsLoading(false);
    });
    
    testProxyButton.addEventListener('click', async () => {
      logElement.innerHTML = '';
      setButtonsLoading(true);
      const result = await testProxyConnection();
      updateConnectionStatus(result.success, result.success ? 'Proxy connected!' : 'Proxy failed');
      setButtonsLoading(false);
    });
    
    // Run tests on page load
    window.addEventListener('DOMContentLoaded', runAllTests);
    
    // Add a jsonp endpoint fallback
    window.jsonpCallback = function(data) {
      log(`Got unexpected JSONP callback with data: ${JSON.stringify(data)}`, 'warning');
    };
  </script>
</body>
</html>