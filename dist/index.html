<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Right Peg Match - Connection Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      line-height: 1.5;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    h1 {
      color: #2563eb;
      margin-top: 0;
    }
    .log {
      font-family: monospace;
      font-size: 13px;
      background-color: #f1f5f9;
      padding: 15px;
      border-radius: 6px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    .success {
      color: green;
      font-weight: bold;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    .warning {
      color: orange;
      font-weight: bold;
    }
    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }
    button:hover {
      background-color: #1d4ed8;
    }
    .code {
      font-family: monospace;
      background-color: #f1f5f9;
      padding: 2px 4px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Right Peg Match Connection Test</h1>
    <p>This page tests connectivity between Netlify (frontend) and Replit (backend).</p>
    
    <h2>Backend API Endpoint</h2>
    <p class="code">https://7a407b74-b1a3-43f7-bf8a-d00fad3554e3-00-15b02g7uh8r3y.riker.replit.dev/api</p>
    
    <div>
      <h2>Connection Status: <span id="status" class="warning">Testing...</span></h2>
      <div id="log" class="log">Initializing connection tests...</div>
      <button id="test-button">Run Tests Again</button>
    </div>
  </div>

  <div class="card">
    <h2>Connection Troubleshooting</h2>
    <p>If you're experiencing connection issues:</p>
    <ol>
      <li>Check if the Replit server is running</li>
      <li>Verify the Replit domain is correct</li>
      <li>Check for domain restrictions or firewalls</li>
      <li>Try accessing the Replit URL directly in your browser</li>
    </ol>
  </div>

  <script>
    const API_URL = 'https://7a407b74-b1a3-43f7-bf8a-d00fad3554e3-00-15b02g7uh8r3y.riker.replit.dev/api';
    const statusElement = document.getElementById('status');
    const logElement = document.getElementById('log');
    const testButton = document.getElementById('test-button');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toISOString().split('T')[1].slice(0, 8);
      const className = type === 'error' ? 'error' : 
                        type === 'success' ? 'success' : 
                        type === 'warning' ? 'warning' : '';
      
      const formattedMessage = `[${timestamp}] ${message}`;
      console.log(formattedMessage);
      
      logElement.innerHTML += `<div class="${className}">${formattedMessage}</div>`;
      logElement.scrollTop = logElement.scrollHeight;
    }
    
    async function testConnection() {
      logElement.innerHTML = '';
      statusElement.innerHTML = 'Testing...';
      statusElement.className = 'warning';
      
      log('Starting connection tests...');
      
      // Test 1: Direct API test with fetch
      try {
        log('Test 1: Direct fetch with no-cors mode');
        const startTime = Date.now();
        const response = await fetch(`${API_URL}/ping-test?t=${Date.now()}`, {
          method: 'GET',
          mode: 'no-cors',
          cache: 'no-cache'
        });
        const elapsed = Date.now() - startTime;
        
        log(`Received response in ${elapsed}ms (Note: This always returns "opaque" with no-cors)`, 'success');
        log('Basic connectivity appears to be working', 'success');
      } catch (error) {
        log(`Test 1 failed: ${error.message}`, 'error');
      }
      
      // Test 2: Image ping test
      try {
        log('Test 2: Image ping test');
        
        // Create a promise that resolves on image load or rejects on error
        const imagePromise = new Promise((resolve, reject) => {
          const img = new Image();
          const startTime = Date.now();
          
          img.onload = function() {
            const elapsed = Date.now() - startTime;
            resolve(`Image loaded successfully in ${elapsed}ms`);
          };
          
          img.onerror = function() {
            reject(new Error(`Failed to load image after ${Date.now() - startTime}ms`));
          };
          
          // Set source with cache-busting query param
          img.src = `${API_URL}/ping-image?t=${Date.now()}`;
          log(`Requesting image from: ${img.src}`);
        });
        
        // Add a timeout
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Image request timed out after 5 seconds')), 5000);
        });
        
        // Race between the image loading and the timeout
        const result = await Promise.race([imagePromise, timeoutPromise]);
        log(result, 'success');
      } catch (error) {
        log(`Test 2 failed: ${error.message}`, 'error');
      }
      
      // Test 3: Prefetch test
      try {
        log('Test 3: Alternative connection test');
        
        // Create a request with just the timestamp for caching
        const link = document.createElement('link');
        link.rel = 'prefetch';
        const startTime = Date.now();
        link.href = `${API_URL}/ping-test?t=${Date.now()}`;
        link.onload = function() {
          log(`Prefetch request completed in ${Date.now() - startTime}ms`, 'success');
        };
        link.onerror = function() {
          log(`Prefetch request failed after ${Date.now() - startTime}ms`, 'warning');
        };
        document.head.appendChild(link);
        
        log('Prefetch request sent');
      } catch (error) {
        log(`Test 3 failed: ${error.message}`, 'error');
      }
      
      // Final connection check using a cors proxy
      try {
        const checkUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(API_URL + '/ping-test?t=' + Date.now())}`;
        log(`Test 4: Using proxy service to check connectivity`);
        
        const response = await fetch(checkUrl);
        if (response.ok) {
          const data = await response.json();
          if (data.contents && data.contents.includes('online')) {
            log(`API is reachable via proxy service: ${data.contents}`, 'success');
            statusElement.innerHTML = 'Connected (via proxy)';
            statusElement.className = 'success';
          } else {
            log(`API returned unexpected response via proxy`, 'warning');
          }
        } else {
          log(`Proxy service returned status ${response.status}`, 'warning');
        }
      } catch (error) {
        log(`Test 4 failed: ${error.message}`, 'error');
      }
      
      log('All connection tests completed. See results above.');
      
      // Update final status based on test results
      if (logElement.innerHTML.includes('success')) {
        statusElement.innerHTML = 'Connection working';
        statusElement.className = 'success';
      } else {
        statusElement.innerHTML = 'Connection issues detected';
        statusElement.className = 'error';
      }
    }
    
    // Initialize tests
    testButton.addEventListener('click', testConnection);
    window.addEventListener('DOMContentLoaded', testConnection);
  </script>
</body>
</html>